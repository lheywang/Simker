# Wrappergen

This powerfull tool enable the user to totally forget the underlayers of mixed-simulation with ngspice.
Wrappergen is designed to emit several files that represent the inputs :

- XSCHEM symbol file, to streamline it's integration into larger projects.
- SPICE netlist file, to generate a subcircuit that include all the necessary to work. You only need to include it and connect it !
- Combine multiple RTL (verilog) files into an higher level one. Can be configured to expose all ports, or try to combine them.

## How to use it ?

For all of the subsequents call, the example "mixed_sim_xschem" will be used.

### Simple RTL example : 

Here, we have two files : 

- clk_div.vhd
- counter.v

And we want to connect them in the following way : 

> clk -> clk_div -> counter -> outputs

The modules exposes theses pins :

clk_div : 
```verilog
entity clk_div is
    port ( 
        clk, rstn: in std_logic;
        clk2: out std_logic);
end clk_div;
```

counter.v : 
```verilog
module counter (  input clk2,              
                  input rstn,             
                  output reg[3:0] out); 
```

---

Rapidly, we can see that some ports use the same name (clk2, rstn)...
And, that's exactly what wrappergen script will do ! 

It'll look at names and try to combine / share them !
- Two inputs with the same name ? As "rstn" ? Let's share them, and only expose a single pin !
- One output and one input with the same name ? As "clk2" ? Let's keep it private, and connect it internally !

That's why, after the vhdl -> verilog conversion, as explained in another tutorial [vhdl2verilog](https://github.com/lheywang/Simker/blob/main/tutorials/vhdl2verilog.md), 
wrappergen will emit theses files : 

```verilog
// =========================================
// THIS FILE WAS AUTOGENERATED. DO NOT EDIT.
// =========================================

module top (

    input    [  0:0   ] rstn,
    input    [  0:0   ] clk_div_clk,
    output   [  3:0   ] counter_out

);

    wire [  0:0   ] clk2;

    clk_div u_clk_div (
        .clk         (clk_div_clk),
        .rstn        (rstn),
        .clk2        (clk2)
    );

    counter u_counter (
        .clk2        (clk2),
        .rstn        (rstn),
        .out         (counter_out)
    );

endmodule

// ===============================================
// FILE WAS CREATED ON : 2026-01-19 22:05:06.423829
// ===============================================

```

> [!NOTE]
> In some case, you may want to control the wiring by yourself. In that case, you create your own top.v file, and pass it wrappergen to generate the symbol as :
> wrappergen --no-binary top.v
>
> --no-binary option is mandatory here, otherwise wrappergen will try to invoke the shared library generator, which will not find your files since it only know top.v. This will fail.

---

We can clearly see that the wires have been matched (rstn only exist a single time, and clk2 isn't exposed).
Along with that, wrappergen created a spice netlist, ready to be included : 

```
.subckt top rstn clk_div_clk counter_out.3 counter_out.2 counter_out.1 counter_out.0
  .model a2d adc_bridge(in_low=1.1 in_high=2.2)
  .model d2a dac_bridge(out_low=0.0 out_high=3.3)

  .model top_model d_cosim simulation="/home/user/dev/Simker/examples/mixed_sim_xschem/top.so"
  
  aADC0 [rstn] [d_rstn] a2d
  aADC1 [clk_div_clk] [d_clk_div_clk] a2d
  
  aDAC0 [d_counter_out.3] [counter_out.3] d2a
  aDAC1 [d_counter_out.2] [counter_out.2] d2a
  aDAC2 [d_counter_out.1] [counter_out.1] d2a
  aDAC3 [d_counter_out.0] [counter_out.0] d2a

  Atop [d_rstn d_clk_div_clk] [d_counter_out.3 d_counter_out.2 d_counter_out.1 d_counter_out.0] top_model
.ends
```

This spice netlist is ready to be used, as it define and include all the necessary. There's no need to do anything, just wire it !
This is done by :

- model a2d and d2a lines to define the analog / digital interfaces, with the proper voltages and thresholds (configured by --voltage argument).
- model top_model line, which include the digital dependency file and insert it into spice.
- aDAC and aADC lines, which perform the conversion between the numeric world ('1', '0', 'X'...) into voltages, compatible with a spice simulator.
- Atop line, which connect all of the elements together.

To be noted, this netlist is encapsulated into a subcircuit, which make it isolated from your circuit. 
You can't access d2a and a2d devices outside of it for example.

Along with that, an XSCHEM symbol file has been generated, which enable the linking between all of that together. 
It can then handle the wiring of others pins to the subcircuit. This symbol file contain near only graphical option, except an automated ".include" statement, which
point to the spice netlist file.

> [!NOTE]
> If your design is more complex than theses, you may want to compile by yourself, by using the (--no-binary) option.
> For example, if counter was depending on another file, which wrappergen couldn't detect by itself, you would end up with compilation errors.
>
> Then, you do :
> wrappergen --no-binary clk_div.v counter.v
> ngspice vlnggen top.v clk_div.v counter.v counter_dep.v

> [!NOTE]
> wrappergen does handle bus expansion by itself, so be aware : With a 32 bit bus as output, you'll get... 32 wires. Which can be quite impractical.

### Simple Analog example :

When in analog mode (--analog), wrappergen will only accept a single source. It will parse it, and then attempt to compile it.

It'll generate some files, located on the /tmp folder, such as : 

- [tmp]/file.v, which is a verilog stub to make it parsable by wrappergen dependency.
- [tmp]/file.va, which is a rewrite of your source file, but with port redeclared. This can garanty the port order, and thus a correct osdi file.

Except from that, wrappergen in analog mode will operate in a very close way compared to the digital mode.